# ============================================
# 开发环境镜像（x86_64）
# ============================================
FROM osrf/ros:humble-desktop-full

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-c"]

# ============================================
# 安装系统依赖
# ============================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # 编译工具
    build-essential \
    cmake \
    git \
    wget \
    curl \
    # Python 开发
    python3-pip \
    python3-dev \
    python3-opencv \
    # ROS2 工具
    python3-colcon-common-extensions \
    python3-rosdep \
    # RealSense 依赖
    libusb-1.0-0-dev \
    libssl-dev \
    libgtk-3-dev \
    libglfw3-dev \
    # 其他工具
    vim \
    htop \
    tmux \
    && rm -rf /var/lib/apt/lists/*

# ============================================
# 安装 RealSense SDK
# ============================================
WORKDIR /tmp
RUN git clone --depth 1 --branch v2.54.2 https://github.com/IntelRealSense/librealsense.git && \
    cd librealsense && \
    mkdir build && cd build && \
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DBUILD_EXAMPLES=false \
        -DBUILD_GRAPHICAL_EXAMPLES=false \
        -DBUILD_PYTHON_BINDINGS=true \
        -DPYTHON_EXECUTABLE=/usr/bin/python3 && \
    make -j$(nproc) && \
    make install && \
    ldconfig && \
    cd ../.. && rm -rf librealsense

# ============================================
# 安装 Python 依赖
# ============================================
COPY requirements.txt /tmp/
RUN pip3 install --no-cache-dir -r /tmp/requirements.txt

# ============================================
# 设置工作空间
# ============================================
WORKDIR /ros2_ws

# ROS2 环境设置
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc && \
    echo "if [ -f /ros2_ws/install/setup.bash ]; then source /ros2_ws/install/setup.bash; fi" >> ~/.bashrc

# 复制启动脚本
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]